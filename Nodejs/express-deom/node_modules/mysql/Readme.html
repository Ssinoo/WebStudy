<!DOCTYPE html><html><head>
      <title>Readme</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\44910\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.13\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="mysql">mysql</h1>

<p><a href="https://npmjs.org/package/mysql"><img src="https://badgen.net/npm/v/mysql" alt="NPM Version"></a><br>
<a href="https://npmjs.org/package/mysql"><img src="https://badgen.net/npm/dm/mysql" alt="NPM Downloads"></a><br>
<a href="https://nodejs.org/en/download"><img src="https://badgen.net/npm/node/mysql" alt="Node.js Version"></a><br>
<a href="https://travis-ci.org/mysqljs/mysql"><img src="https://badgen.net/travis/mysqljs/mysql/master" alt="Linux Build"></a><br>
<a href="https://ci.appveyor.com/project/dougwilson/node-mysql"><img src="https://badgen.net/appveyor/ci/dougwilson/node-mysql/master?label=windows" alt="Windows Build"></a><br>
<a href="https://coveralls.io/r/mysqljs/mysql?branch=master"><img src="https://badgen.net/coveralls/c/github/mysqljs/mysql/master" alt="Test Coverage"></a></p>
<h2 class="mume-header" id="table-of-contents">Table of Contents</h2>

<ul>
<li><a href="#install">Install</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#contributors">Contributors</a></li>
<li><a href="#sponsors">Sponsors</a></li>
<li><a href="#community">Community</a></li>
<li><a href="#establishing-connections">Establishing connections</a></li>
<li><a href="#connection-options">Connection options</a>
<ul>
<li><a href="#ssl-options">SSL options</a></li>
<li><a href="#connection-flags">Connection flags</a></li>
</ul>
</li>
<li><a href="#terminating-connections">Terminating connections</a></li>
<li><a href="#pooling-connections">Pooling connections</a></li>
<li><a href="#pool-options">Pool options</a></li>
<li><a href="#pool-events">Pool events</a>
<ul>
<li><a href="#acquire">acquire</a></li>
<li><a href="#connection">connection</a></li>
<li><a href="#enqueue">enqueue</a></li>
<li><a href="#release">release</a></li>
</ul>
</li>
<li><a href="#closing-all-the-connections-in-a-pool">Closing all the connections in a pool</a></li>
<li><a href="#poolcluster">PoolCluster</a>
<ul>
<li><a href="#poolcluster-options">PoolCluster options</a></li>
</ul>
</li>
<li><a href="#switching-users-and-altering-connection-state">Switching users and altering connection state</a></li>
<li><a href="#server-disconnects">Server disconnects</a></li>
<li><a href="#performing-queries">Performing queries</a></li>
<li><a href="#escaping-query-values">Escaping query values</a></li>
<li><a href="#escaping-query-identifiers">Escaping query identifiers</a>
<ul>
<li><a href="#preparing-queries">Preparing Queries</a></li>
<li><a href="#custom-format">Custom format</a></li>
</ul>
</li>
<li><a href="#getting-the-id-of-an-inserted-row">Getting the id of an inserted row</a></li>
<li><a href="#getting-the-number-of-affected-rows">Getting the number of affected rows</a></li>
<li><a href="#getting-the-number-of-changed-rows">Getting the number of changed rows</a></li>
<li><a href="#getting-the-connection-id">Getting the connection ID</a></li>
<li><a href="#executing-queries-in-parallel">Executing queries in parallel</a></li>
<li><a href="#streaming-query-rows">Streaming query rows</a>
<ul>
<li><a href="#piping-results-with-streams">Piping results with Streams</a></li>
</ul>
</li>
<li><a href="#multiple-statement-queries">Multiple statement queries</a></li>
<li><a href="#stored-procedures">Stored procedures</a></li>
<li><a href="#joins-with-overlapping-column-names">Joins with overlapping column names</a></li>
<li><a href="#transactions">Transactions</a></li>
<li><a href="#ping">Ping</a></li>
<li><a href="#timeouts">Timeouts</a></li>
<li><a href="#error-handling">Error handling</a></li>
<li><a href="#exception-safety">Exception Safety</a></li>
<li><a href="#type-casting">Type casting</a>
<ul>
<li><a href="#number">Number</a></li>
<li><a href="#date">Date</a></li>
<li><a href="#buffer">Buffer</a></li>
<li><a href="#string">String</a></li>
<li><a href="#custom-type-casting">Custom type casting</a></li>
</ul>
</li>
<li><a href="#debugging-and-reporting-problems">Debugging and reporting problems</a></li>
<li><a href="#security-issues">Security issues</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#running-tests">Running tests</a>
<ul>
<li><a href="#running-unit-tests">Running unit tests</a></li>
<li><a href="#running-integration-tests">Running integration tests</a></li>
</ul>
</li>
<li><a href="#todo">Todo</a></li>
</ul>
<h2 class="mume-header" id="install">Install</h2>

<p>This is a <a href="https://nodejs.org/en/">Node.js</a> module available through the<br>
<a href="https://www.npmjs.com/">npm registry</a>.</p>
<p>Before installing, <a href="https://nodejs.org/en/download/">download and install Node.js</a>.<br>
Node.js 0.6 or higher is required.</p>
<p>Installation is done using the<br>
<a href="https://docs.npmjs.com/getting-started/installing-npm-packages-locally"><code>npm install</code> command</a>:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> mysql
</pre><p>For information about the previous 0.9.x releases, visit the <a href="https://github.com/mysqljs/mysql/tree/v0.9">v0.9 branch</a>.</p>
<p>Sometimes I may also ask you to install the latest version from Github to check<br>
if a bugfix is working. In this case, please do:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> mysqljs/mysql
</pre><h2 class="mume-header" id="introduction">Introduction</h2>

<p>This is a node.js driver for mysql. It is written in JavaScript, does not<br>
require compiling, and is 100% MIT licensed.</p>
<p>Here is an example on how to use it:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token punctuation">:</span> <span class="token string">&apos;localhost&apos;</span><span class="token punctuation">,</span>
  user     <span class="token punctuation">:</span> <span class="token string">&apos;me&apos;</span><span class="token punctuation">,</span>
  password <span class="token punctuation">:</span> <span class="token string">&apos;secret&apos;</span><span class="token punctuation">,</span>
  database <span class="token punctuation">:</span> <span class="token string">&apos;my_db&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1 + 1 AS solution&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;The solution is: &apos;</span><span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>From this example, you can learn the following:</p>
<ul>
<li>Every method you invoke on a connection is queued and executed in sequence.</li>
<li>Closing the connection is done using <code>end()</code> which makes sure all remaining<br>
queries are executed before sending a quit packet to the mysql server.</li>
</ul>
<h2 class="mume-header" id="contributors">Contributors</h2>

<p>Thanks goes to the people who have contributed code to this module, see the<br>
<a href="https://github.com/mysqljs/mysql/graphs/contributors">GitHub Contributors page</a>.</p>
<p>Additionally I&apos;d like to thank the following people:</p>
<ul>
<li><a href="http://andrey.hristov.com/">Andrey Hristov</a> (Oracle) - for helping me with protocol questions.</li>
<li><a href="http://blog.ulf-wendel.de/">Ulf Wendel</a> (Oracle) - for helping me with protocol questions.</li>
</ul>
<h2 class="mume-header" id="sponsors">Sponsors</h2>

<p>The following companies have supported this project financially, allowing me to<br>
spend more time on it (ordered by time of contribution):</p>
<ul>
<li><a href="http://transloadit.com">Transloadit</a> (my startup, we do file uploading &amp;<br>
video encoding as a service, check it out)</li>
<li><a href="http://www.joyent.com/">Joyent</a></li>
<li><a href="http://pinkbike.com/">pinkbike.com</a></li>
<li><a href="http://www.holidayextras.co.uk/">Holiday Extras</a> (they are <a href="http://join.holidayextras.co.uk/">hiring</a>)</li>
<li><a href="http://newscope.com/">Newscope</a> (they are <a href="https://newscope.com/unternehmen/jobs/">hiring</a>)</li>
</ul>
<h2 class="mume-header" id="community">Community</h2>

<p>If you&apos;d like to discuss this module, or ask questions about it, please use one<br>
of the following:</p>
<ul>
<li><strong>Mailing list</strong>: <a href="https://groups.google.com/forum/#!forum/node-mysql">https://groups.google.com/forum/#!forum/node-mysql</a></li>
<li><strong>IRC Channel</strong>: #node.js (on <a href="http://freenode.net">freenode.net</a>, I pay attention to any message<br>
including the term <code>mysql</code>)</li>
</ul>
<h2 class="mume-header" id="establishing-connections">Establishing connections</h2>

<p>The recommended way to establish a connection is this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token punctuation">:</span> <span class="token string">&apos;example.org&apos;</span><span class="token punctuation">,</span>
  user     <span class="token punctuation">:</span> <span class="token string">&apos;bob&apos;</span><span class="token punctuation">,</span>
  password <span class="token punctuation">:</span> <span class="token string">&apos;secret&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&apos;error connecting: &apos;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;connected as id &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>However, a connection can also be implicitly established by invoking a query:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// connected!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Depending on how you like to handle your errors, either method may be<br>
appropriate. Any type of connection error (handshake or network) is considered<br>
a fatal error, see the <a href="#error-handling">Error Handling</a> section for more<br>
information.</p>
<h2 class="mume-header" id="connection-options">Connection options</h2>

<p>When establishing a connection, you can set the following options:</p>
<ul>
<li><code>host</code>: The hostname of the database you are connecting to. (Default:<br>
<code>localhost</code>)</li>
<li><code>port</code>: The port number to connect to. (Default: <code>3306</code>)</li>
<li><code>localAddress</code>: The source IP address to use for TCP connection. (Optional)</li>
<li><code>socketPath</code>: The path to a unix domain socket to connect to. When used <code>host</code><br>
and <code>port</code> are ignored.</li>
<li><code>user</code>: The MySQL user to authenticate as.</li>
<li><code>password</code>: The password of that MySQL user.</li>
<li><code>database</code>: Name of the database to use for this connection (Optional).</li>
<li><code>charset</code>: The charset for the connection. This is called &quot;collation&quot; in the SQL-level<br>
of MySQL (like <code>utf8_general_ci</code>). If a SQL-level charset is specified (like <code>utf8mb4</code>)<br>
then the default collation for that charset is used. (Default: <code>&apos;UTF8_GENERAL_CI&apos;</code>)</li>
<li><code>timezone</code>: The timezone configured on the MySQL server. This is used to type cast server date/time values to JavaScript <code>Date</code> object and vice versa. This can be <code>&apos;local&apos;</code>, <code>&apos;Z&apos;</code>, or an offset in the form <code>+HH:MM</code> or <code>-HH:MM</code>. (Default: <code>&apos;local&apos;</code>)</li>
<li><code>connectTimeout</code>: The milliseconds before a timeout occurs during the initial connection<br>
to the MySQL server. (Default: <code>10000</code>)</li>
<li><code>stringifyObjects</code>: Stringify objects instead of converting to values. See<br>
issue <a href="https://github.com/mysqljs/mysql/issues/501">#501</a>. (Default: <code>false</code>)</li>
<li><code>insecureAuth</code>: Allow connecting to MySQL instances that ask for the old<br>
(insecure) authentication method. (Default: <code>false</code>)</li>
<li><code>typeCast</code>: Determines if column values should be converted to native<br>
JavaScript types. (Default: <code>true</code>)</li>
<li><code>queryFormat</code>: A custom query format function. See <a href="#custom-format">Custom format</a>.</li>
<li><code>supportBigNumbers</code>: When dealing with big numbers (BIGINT and DECIMAL columns) in the database,<br>
you should enable this option (Default: <code>false</code>).</li>
<li><code>bigNumberStrings</code>: Enabling both <code>supportBigNumbers</code> and <code>bigNumberStrings</code> forces big numbers<br>
(BIGINT and DECIMAL columns) to be always returned as JavaScript String objects (Default: <code>false</code>).<br>
Enabling <code>supportBigNumbers</code> but leaving <code>bigNumberStrings</code> disabled will return big numbers as String<br>
objects only when they cannot be accurately represented with [JavaScript Number objects] (<a href="http://ecma262-5.com/ELS5_HTML.htm#Section_8.5">http://ecma262-5.com/ELS5_HTML.htm#Section_8.5</a>)<br>
(which happens when they exceed the [-2^53, +2^53] range), otherwise they will be returned as<br>
Number objects. This option is ignored if <code>supportBigNumbers</code> is disabled.</li>
<li><code>dateStrings</code>: Force date types (TIMESTAMP, DATETIME, DATE) to be returned as strings rather than<br>
inflated into JavaScript Date objects. Can be <code>true</code>/<code>false</code> or an array of type names to keep as<br>
strings. (Default: <code>false</code>)</li>
<li><code>debug</code>: Prints protocol details to stdout. Can be <code>true</code>/<code>false</code> or an array of packet type names<br>
that should be printed. (Default: <code>false</code>)</li>
<li><code>trace</code>: Generates stack traces on <code>Error</code> to include call site of library<br>
entrance (&quot;long stack traces&quot;). Slight performance penalty for most calls.<br>
(Default: <code>true</code>)</li>
<li><code>localInfile</code>: Allow <code>LOAD DATA INFILE</code> to use the <code>LOCAL</code> modifier. (Default: <code>true</code>)</li>
<li><code>multipleStatements</code>: Allow multiple mysql statements per query. Be careful<br>
with this, it could increase the scope of SQL injection attacks. (Default: <code>false</code>)</li>
<li><code>flags</code>: List of connection flags to use other than the default ones. It is<br>
also possible to blacklist default ones. For more information, check<br>
<a href="#connection-flags">Connection Flags</a>.</li>
<li><code>ssl</code>: object with ssl parameters or a string containing name of ssl profile. See <a href="#ssl-options">SSL options</a>.</li>
</ul>
<p>In addition to passing these options as an object, you can also use a url<br>
string. For example:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token string">&apos;mysql://user:pass@host/db?debug=true&amp;charset=BIG5_CHINESE_CI&amp;timezone=-0700&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Note: The query values are first attempted to be parsed as JSON, and if that<br>
fails assumed to be plaintext strings.</p>
<h3 class="mume-header" id="ssl-options">SSL options</h3>

<p>The <code>ssl</code> option in the connection options takes a string or an object. When given a string,<br>
it uses one of the predefined SSL profiles included. The following profiles are included:</p>
<ul>
<li><code>&quot;Amazon RDS&quot;</code>: this profile is for connecting to an Amazon RDS server and contains the<br>
certificates from <a href="https://rds.amazonaws.com/doc/rds-ssl-ca-cert.pem">https://rds.amazonaws.com/doc/rds-ssl-ca-cert.pem</a> and<br>
<a href="https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem">https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem</a></li>
</ul>
<p>When connecting to other servers, you will need to provide an object of options, in the<br>
same format as <a href="https://nodejs.org/api/tls.html#tls_tls_createsecurecontext_options">tls.createSecureContext</a>.<br>
Please note the arguments expect a string of the certificate, not a file name to the<br>
certificate. Here is a simple example:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host <span class="token punctuation">:</span> <span class="token string">&apos;localhost&apos;</span><span class="token punctuation">,</span>
  ssl  <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    ca <span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&apos;/mysql-ca.crt&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You can also connect to a MySQL server without properly providing the appropriate<br>
CA to trust. <em>You should not do this</em>.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host <span class="token punctuation">:</span> <span class="token string">&apos;localhost&apos;</span><span class="token punctuation">,</span>
  ssl  <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// DO NOT DO THIS</span>
    <span class="token comment">// set up your ca correctly to trust the connection</span>
    rejectUnauthorized<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="connection-flags">Connection flags</h3>

<p>If, for any reason, you would like to change the default connection flags, you<br>
can use the connection option <code>flags</code>. Pass a string with a comma separated list<br>
of items to add to the default flags. If you don&apos;t want a default flag to be used<br>
prepend the flag with a minus sign. To add a flag that is not in the default list,<br>
just write the flag name, or prefix it with a plus (case insensitive).</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// disable FOUND_ROWS flag, enable IGNORE_SPACE flag</span>
  flags<span class="token punctuation">:</span> <span class="token string">&apos;-FOUND_ROWS,IGNORE_SPACE&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The following flags are available:</p>
<ul>
<li><code>COMPRESS</code> - Enable protocol compression. This feature is not currently supported<br>
by the Node.js implementation so cannot be turned on. (Default off)</li>
<li><code>CONNECT_WITH_DB</code> - Ability to specify the database on connection. (Default on)</li>
<li><code>FOUND_ROWS</code> - Send the found rows instead of the affected rows as <code>affectedRows</code>.<br>
(Default on)</li>
<li><code>IGNORE_SIGPIPE</code> - Don&apos;t issue SIGPIPE if network failures. This flag has no effect<br>
on this Node.js implementation. (Default on)</li>
<li><code>IGNORE_SPACE</code> - Let the parser ignore spaces before the <code>(</code> in queries. (Default on)</li>
<li><code>INTERACTIVE</code> - Indicates to the MySQL server this is an &quot;interactive&quot; client. This<br>
will use the interactive timeouts on the MySQL server and report as interactive in<br>
the process list. (Default off)</li>
<li><code>LOCAL_FILES</code> - Can use <code>LOAD DATA LOCAL</code>. This flag is controlled by the connection<br>
option <code>localInfile</code>. (Default on)</li>
<li><code>LONG_FLAG</code> - Longer flags in Protocol::ColumnDefinition320. (Default on)</li>
<li><code>LONG_PASSWORD</code> - Use the improved version of Old Password Authentication.<br>
(Default on)</li>
<li><code>MULTI_RESULTS</code> - Can handle multiple resultsets for queries. (Default on)</li>
<li><code>MULTI_STATEMENTS</code> - The client may send multiple statement per query or<br>
statement prepare (separated by <code>;</code>). This flag is controlled by the connection<br>
option <code>multipleStatements</code>. (Default off)</li>
<li><code>NO_SCHEMA</code></li>
<li><code>ODBC</code> Special handling of ODBC behaviour. This flag has no effect on this Node.js<br>
implementation. (Default on)</li>
<li><code>PLUGIN_AUTH</code> - Uses the plugin authentication mechanism when connecting to the<br>
MySQL server. This feature is not currently supported by the Node.js implementation<br>
so cannot be turned on. (Default off)</li>
<li><code>PROTOCOL_41</code> - Uses the 4.1 protocol. (Default on)</li>
<li><code>PS_MULTI_RESULTS</code> - Can handle multiple resultsets for execute. (Default on)</li>
<li><code>REMEMBER_OPTIONS</code> - This is specific to the C client, and has no effect on this<br>
Node.js implementation. (Default off)</li>
<li><code>RESERVED</code> - Old flag for the 4.1 protocol. (Default on)</li>
<li><code>SECURE_CONNECTION</code> - Support native 4.1 authentication. (Default on)</li>
<li><code>SSL</code> - Use SSL after handshake to encrypt data in transport. This feature is<br>
controlled though the <code>ssl</code> connection option, so the flag has no effect.<br>
(Default off)</li>
<li><code>SSL_VERIFY_SERVER_CERT</code> - Verify the server certificate during SSL set up. This<br>
feature is controlled though the <code>ssl.rejectUnauthorized</code> connection option, so<br>
the flag has no effect. (Default off)</li>
<li><code>TRANSACTIONS</code> - Asks for the transaction status flags. (Default on)</li>
</ul>
<h2 class="mume-header" id="terminating-connections">Terminating connections</h2>

<p>There are two ways to end a connection. Terminating a connection gracefully is<br>
done by calling the <code>end()</code> method:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The connection is terminated now</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>This will make sure all previously enqueued queries are still before sending a<br>
<code>COM_QUIT</code> packet to the MySQL server. If a fatal error occurs before the<br>
<code>COM_QUIT</code> packet can be sent, an <code>err</code> argument will be provided to the<br>
callback, but the connection will be terminated regardless of that.</p>
<p>An alternative way to end the connection is to call the <code>destroy()</code> method.<br>
This will cause an immediate termination of the underlying socket.<br>
Additionally <code>destroy()</code> guarantees that no more events or callbacks will be<br>
triggered for the connection.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Unlike <code>end()</code> the <code>destroy()</code> method does not take a callback argument.</p>
<h2 class="mume-header" id="pooling-connections">Pooling connections</h2>

<p>Rather than creating and managing connections one-by-one, this module also<br>
provides built-in connection pooling using <code>mysql.createPool(config)</code>.<br>
<a href="https://en.wikipedia.org/wiki/Connection_pool">Read more about connection pooling</a>.</p>
<p>Create a pool and use it directly:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool  <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  connectionLimit <span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  host            <span class="token punctuation">:</span> <span class="token string">&apos;example.org&apos;</span><span class="token punctuation">,</span>
  user            <span class="token punctuation">:</span> <span class="token string">&apos;bob&apos;</span><span class="token punctuation">,</span>
  password        <span class="token punctuation">:</span> <span class="token string">&apos;secret&apos;</span><span class="token punctuation">,</span>
  database        <span class="token punctuation">:</span> <span class="token string">&apos;my_db&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1 + 1 AS solution&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;The solution is: &apos;</span><span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>This is a shortcut for the <code>pool.getConnection()</code> -&gt; <code>connection.query()</code> -&gt;<br>
<code>connection.release()</code> code flow. Using <code>pool.getConnection()</code> is useful to<br>
share connection state for subsequent queries. This is because two calls to<br>
<code>pool.query()</code> may use two different connections and run in parallel. This is<br>
the basic structure:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool  <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token comment">// not connected!</span>

  <span class="token comment">// Use the connection</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT something FROM sometable&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// When done with the connection, release it.</span>
    connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Handle error after the release.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>

    <span class="token comment">// Don&apos;t use the connection here, it has been returned to the pool.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>If you would like to close the connection and remove it from the pool, use<br>
<code>connection.destroy()</code> instead. The pool will create a new connection the next<br>
time one is needed.</p>
<p>Connections are lazily created by the pool. If you configure the pool to allow<br>
up to 100 connections, but only ever use 5 simultaneously, only 5 connections<br>
will be made. Connections are also cycled round-robin style, with connections<br>
being taken from the top of the pool and returning to the bottom.</p>
<p>When a previous connection is retrieved from the pool, a ping packet is sent<br>
to the server to check if the connection is still good.</p>
<h2 class="mume-header" id="pool-options">Pool options</h2>

<p>Pools accept all the same <a href="#connection-options">options as a connection</a>.<br>
When creating a new connection, the options are simply passed to the connection<br>
constructor. In addition to those options pools accept a few extras:</p>
<ul>
<li><code>acquireTimeout</code>: The milliseconds before a timeout occurs during the connection<br>
acquisition. This is slightly different from <code>connectTimeout</code>, because acquiring<br>
a pool connection does not always involve making a connection. If a connection<br>
request is queued, the time the request spends in the queue does not count<br>
towards this timeout. (Default: <code>10000</code>)</li>
<li><code>waitForConnections</code>: Determines the pool&apos;s action when no connections are<br>
available and the limit has been reached. If <code>true</code>, the pool will queue the<br>
connection request and call it when one becomes available. If <code>false</code>, the<br>
pool will immediately call back with an error. (Default: <code>true</code>)</li>
<li><code>connectionLimit</code>: The maximum number of connections to create at once.<br>
(Default: <code>10</code>)</li>
<li><code>queueLimit</code>: The maximum number of connection requests the pool will queue<br>
before returning an error from <code>getConnection</code>. If set to <code>0</code>, there is no<br>
limit to the number of queued connection requests. (Default: <code>0</code>)</li>
</ul>
<h2 class="mume-header" id="pool-events">Pool events</h2>

<h3 class="mume-header" id="acquire">acquire</h3>

<p>The pool will emit an <code>acquire</code> event when a connection is acquired from the pool.<br>
This is called after all acquiring activity has been performed on the connection,<br>
right before the connection is handed to the callback of the acquiring code.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;acquire&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;Connection %d acquired&apos;</span><span class="token punctuation">,</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="connection">connection</h3>

<p>The pool will emit a <code>connection</code> event when a new connection is made within the pool.<br>
If you need to set session variables on the connection before it gets used, you can<br>
listen to the <code>connection</code> event.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;connection&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SET SESSION auto_increment_increment=1&apos;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="enqueue">enqueue</h3>

<p>The pool will emit an <code>enqueue</code> event when a callback has been queued to wait for<br>
an available connection.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;enqueue&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;Waiting for available connection slot&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="release">release</h3>

<p>The pool will emit a <code>release</code> event when a connection is released back to the<br>
pool. This is called after all release activity has been performed on the connection,<br>
so the connection will be listed as free at the time of the event.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;release&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;Connection %d released&apos;</span><span class="token punctuation">,</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="closing-all-the-connections-in-a-pool">Closing all the connections in a pool</h2>

<p>When you are done using the pool, you have to end all the connections or the<br>
Node.js event loop will stay active until the connections are closed by the<br>
MySQL server. This is typically done if the pool is used in a script or when<br>
trying to gracefully shutdown a server. To end all the connections in the<br>
pool, use the <code>end</code> method on the pool:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">pool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// all connections in the pool have ended</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The <code>end</code> method takes an <em>optional</em> callback that you can use to know when<br>
all the connections are ended.</p>
<p><strong>Once <code>pool.end</code> is called, <code>pool.getConnection</code> and other operations<br>
can no longer be performed.</strong> Wait until all connections in the pool are<br>
released before calling <code>pool.end</code>. If you use the shortcut method<br>
<code>pool.query</code>, in place of <code>pool.getConnection</code> &#x2192; <code>connection.query</code> &#x2192;<br>
<code>connection.release</code>, wait until it completes.</p>
<p><code>pool.end</code> calls <code>connection.end</code> on every active connection in the pool.<br>
This queues a <code>QUIT</code> packet on the connection and sets a flag to prevent<br>
<code>pool.getConnection</code> from creating new connections. All commands / queries<br>
already in progress will complete, but new commands won&apos;t execute.</p>
<h2 class="mume-header" id="poolcluster">PoolCluster</h2>

<p>PoolCluster provides multiple hosts connection. (group &amp; retry &amp; selector)</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// create</span>
<span class="token keyword">var</span> poolCluster <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPoolCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add configurations (the config is a pool config object)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add configuration with automatic name</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&apos;MASTER&apos;</span><span class="token punctuation">,</span> masterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add a named configuration</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE1&apos;</span><span class="token punctuation">,</span> slave1Config<span class="token punctuation">)</span><span class="token punctuation">;</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE2&apos;</span><span class="token punctuation">,</span> slave2Config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// remove configurations</span>
poolCluster<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE2&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// By nodeId</span>
poolCluster<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE*&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// By target group : SLAVE1-2</span>

<span class="token comment">// Target Group : ALL(anonymous, MASTER, SLAVE1-2), Selector : round-robin(default)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Target Group : MASTER, Selector : round-robin</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&apos;MASTER&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Target Group : SLAVE1-2, Selector : order</span>
<span class="token comment">// If can&apos;t connect to SLAVE1, return SLAVE2. (remove SLAVE1 in the cluster)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;remove&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nodeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;REMOVED NODE : &apos;</span> <span class="token operator">+</span> nodeId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// nodeId = SLAVE1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// A pattern can be passed with *  as wildcard</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE*&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;ORDER&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The pattern can also be a regular expression</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token regex">/^SLAVE[12]$/</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// of namespace : of(pattern, selector)</span>
poolCluster<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token string">&apos;*&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> pool <span class="token operator">=</span> poolCluster<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token string">&apos;SLAVE*&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;RANDOM&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// close all connections</span>
poolCluster<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// all connections in the pool cluster have ended</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="poolcluster-options">PoolCluster options</h3>

<ul>
<li><code>canRetry</code>: If <code>true</code>, <code>PoolCluster</code> will attempt to reconnect when connection fails. (Default: <code>true</code>)</li>
<li><code>removeNodeErrorCount</code>: If connection fails, node&apos;s <code>errorCount</code> increases.<br>
When <code>errorCount</code> is greater than <code>removeNodeErrorCount</code>, remove a node in the <code>PoolCluster</code>. (Default: <code>5</code>)</li>
<li><code>restoreNodeTimeout</code>: If connection fails, specifies the number of milliseconds<br>
before another connection attempt will be made. If set to <code>0</code>, then node will be<br>
removed instead and never re-used. (Default: <code>0</code>)</li>
<li><code>defaultSelector</code>: The default selector. (Default: <code>RR</code>)
<ul>
<li><code>RR</code>: Select one alternately. (Round-Robin)</li>
<li><code>RANDOM</code>: Select the node by random function.</li>
<li><code>ORDER</code>: Select the first node available unconditionally.</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> clusterConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  removeNodeErrorCount<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// Remove the node immediately when connection fails.</span>
  defaultSelector<span class="token punctuation">:</span> <span class="token string">&apos;ORDER&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> poolCluster <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPoolCluster</span><span class="token punctuation">(</span>clusterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="switching-users-and-altering-connection-state">Switching users and altering connection state</h2>

<p>MySQL offers a changeUser command that allows you to alter the current user and<br>
other aspects of the connection without shutting down the underlying socket:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">changeUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user <span class="token punctuation">:</span> <span class="token string">&apos;john&apos;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The available options for this feature are:</p>
<ul>
<li><code>user</code>: The name of the new user (defaults to the previous one).</li>
<li><code>password</code>: The password of the new user (defaults to the previous one).</li>
<li><code>charset</code>: The new charset (defaults to the previous one).</li>
<li><code>database</code>: The new database (defaults to the previous one).</li>
</ul>
<p>A sometimes useful side effect of this functionality is that this function also<br>
resets any connection state (variables, transactions, etc.).</p>
<p>Errors encountered during this operation are treated as fatal connection errors<br>
by this module.</p>
<h2 class="mume-header" id="server-disconnects">Server disconnects</h2>

<p>You may lose the connection to a MySQL server due to network problems, the<br>
server timing you out, the server being restarted, or crashing. All of these<br>
events are considered fatal errors, and will have the <code>err.code = &apos;PROTOCOL_CONNECTION_LOST&apos;</code>.  See the <a href="#error-handling">Error Handling</a> section<br>
for more information.</p>
<p>Re-connecting a connection is done by establishing a new connection. Once<br>
terminated, an existing connection object cannot be re-connected by design.</p>
<p>With Pool, disconnected connections will be removed from the pool freeing up<br>
space for a new connection to be created on the next getConnection call.</p>
<p>With PoolCluster, disconnected connections will count as errors against the<br>
related node, incrementing the error code for that node. Once there are more than<br>
<code>removeNodeErrorCount</code> errors on a given node, it is removed from the cluster.<br>
When this occurs, the PoolCluster may emit a <code>POOL_NONEONLINE</code> error if there are<br>
no longer any matching nodes for the pattern. The <code>restoreNodeTimeout</code> config can<br>
be set to restore offline nodes after a given timeout.</p>
<h2 class="mume-header" id="performing-queries">Performing queries</h2>

<p>The most basic way to perform a query is to call the <code>.query()</code> method on an object<br>
(like a <code>Connection</code>, <code>Pool</code>, or <code>PoolNamespace</code> instance).</p>
<p>The simplest form of .<code>query()</code> is <code>.query(sqlString, callback)</code>, where a SQL string<br>
is the first argument and the second is a callback:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM `books` WHERE `author` = &quot;David&quot;&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The second form <code>.query(sqlString, values, callback)</code> comes when using<br>
placeholder values (see <a href="#escaping-query-values">escaping query values</a>):</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM `books` WHERE `author` = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&apos;David&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The third form <code>.query(options, callback)</code> comes when using various advanced<br>
options on the query, like <a href="#escaping-query-values">escaping query values</a>,<br>
<a href="#joins-with-overlapping-column-names">joins with overlapping column names</a>,<br>
<a href="#timeout">timeouts</a>, and <a href="#type-casting">type casting</a>.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  sql<span class="token punctuation">:</span> <span class="token string">&apos;SELECT * FROM `books` WHERE `author` = ?&apos;</span><span class="token punctuation">,</span>
  timeout<span class="token punctuation">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token comment">// 40s</span>
  values<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&apos;David&apos;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Note that a combination of the second and third forms can be used where the<br>
placeholder values are passed as an argument and not in the options object.<br>
The <code>values</code> argument will override the <code>values</code> in the option object.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    sql<span class="token punctuation">:</span> <span class="token string">&apos;SELECT * FROM `books` WHERE `author` = ?&apos;</span><span class="token punctuation">,</span>
    timeout<span class="token punctuation">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token comment">// 40s</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&apos;David&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// error will be an Error if one occurred during the query</span>
    <span class="token comment">// results will contain the results of the query</span>
    <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>If the query only has a single replacement character (<code>?</code>), and the value is<br>
not <code>null</code>, <code>undefined</code>, or an array, it can be passed directly as the second<br>
argument to <code>.query</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
  <span class="token string">&apos;SELECT * FROM `books` WHERE `author` = ?&apos;</span><span class="token punctuation">,</span>
  <span class="token string">&apos;David&apos;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// error will be an Error if one occurred during the query</span>
    <span class="token comment">// results will contain the results of the query</span>
    <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="escaping-query-values">Escaping query values</h2>

<p><strong>Caution</strong> These methods of escaping values only works when the<br>
<a href="https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html#sqlmode_no_backslash_escapes">NO_BACKSLASH_ESCAPES</a><br>
SQL mode is disabled (which is the default state for MySQL servers).</p>
<p>In order to avoid SQL Injection attacks, you should always escape any user<br>
provided data before using it inside a SQL query. You can do so using the<br>
<code>mysql.escape()</code>, <code>connection.escape()</code> or <code>pool.escape()</code> methods:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token string">&apos;some user provided value&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">&apos;SELECT * FROM users WHERE id = &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Alternatively, you can use <code>?</code> characters as placeholders for values you would<br>
like to have escaped like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM users WHERE id = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Multiple placeholders are mapped to values in the same order as passed. For example,<br>
in the following query <code>foo</code> equals <code>a</code>, <code>bar</code> equals <code>b</code>, <code>baz</code> equals <code>c</code>, and<br>
<code>id</code> will be <code>userId</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;UPDATE users SET foo = ?, bar = ?, baz = ? WHERE id = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&apos;a&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;b&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;c&apos;</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>This looks similar to prepared statements in MySQL, however it really just uses<br>
the same <code>connection.escape()</code> method internally.</p>
<p><strong>Caution</strong> This also differs from prepared statements in that all <code>?</code> are<br>
replaced, even those contained in comments and strings.</p>
<p>Different value types are escaped differently, here is how:</p>
<ul>
<li>Numbers are left untouched</li>
<li>Booleans are converted to <code>true</code> / <code>false</code></li>
<li>Date objects are converted to <code>&apos;YYYY-mm-dd HH:ii:ss&apos;</code> strings</li>
<li>Buffers are converted to hex strings, e.g. <code>X&apos;0fa5&apos;</code></li>
<li>Strings are safely escaped</li>
<li>Arrays are turned into list, e.g. <code>[&apos;a&apos;, &apos;b&apos;]</code> turns into <code>&apos;a&apos;, &apos;b&apos;</code></li>
<li>Nested arrays are turned into grouped lists (for bulk inserts), e.g. <code>[[&apos;a&apos;, &apos;b&apos;], [&apos;c&apos;, &apos;d&apos;]]</code> turns into <code>(&apos;a&apos;, &apos;b&apos;), (&apos;c&apos;, &apos;d&apos;)</code></li>
<li>Objects that have a <code>toSqlString</code> method will have <code>.toSqlString()</code> called<br>
and the returned value is used as the raw SQL.</li>
<li>Objects are turned into <code>key = &apos;val&apos;</code> pairs for each enumerable property on<br>
the object. If the property&apos;s value is a function, it is skipped; if the<br>
property&apos;s value is an object, toString() is called on it and the returned<br>
value is used.</li>
<li><code>undefined</code> / <code>null</code> are converted to <code>NULL</code></li>
<li><code>NaN</code> / <code>Infinity</code> are left as-is. MySQL does not support these, and trying<br>
to insert them as values will trigger MySQL errors until they implement<br>
support.</li>
</ul>
<p>This escaping allows you to do neat things like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> post  <span class="token operator">=</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">&apos;Hello MySQL&apos;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO posts SET ?&apos;</span><span class="token punctuation">,</span> post<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// Neat!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// INSERT INTO posts SET `id` = 1, `title` = &apos;Hello MySQL&apos;</span>
</pre><p>And the <code>toSqlString</code> method allows you to form complex queries with functions:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function-variable function">toSqlString</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&apos;CURRENT_TIMESTAMP()&apos;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&apos;UPDATE posts SET modified = ? WHERE id = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATE posts SET modified = CURRENT_TIMESTAMP() WHERE id = 42</span>
</pre><p>To generate objects with a <code>toSqlString</code> method, the <code>mysql.raw()</code> method can<br>
be used. This creates an object that will be left un-touched when using in a <code>?</code><br>
placeholder, useful for using functions as dynamic values:</p>
<p><strong>Caution</strong> The string provided to <code>mysql.raw()</code> will skip all escaping<br>
functions when used, so be careful when passing in unvalidated input.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&apos;CURRENT_TIMESTAMP()&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&apos;UPDATE posts SET modified = ? WHERE id = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UPDATE posts SET modified = CURRENT_TIMESTAMP() WHERE id = 42</span>
</pre><p>If you feel the need to escape queries by yourself, you can also use the escaping<br>
function directly:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> query <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM posts WHERE title=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">&quot;Hello MySQL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SELECT * FROM posts WHERE title=&apos;Hello MySQL&apos;</span>
</pre><h2 class="mume-header" id="escaping-query-identifiers">Escaping query identifiers</h2>

<p>If you can&apos;t trust an SQL identifier (database / table / column name) because it is<br>
provided by a user, you should escape it with <code>mysql.escapeId(identifier)</code>,<br>
<code>connection.escapeId(identifier)</code> or <code>pool.escapeId(identifier)</code> like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> sorter <span class="token operator">=</span> <span class="token string">&apos;date&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">&apos;SELECT * FROM posts ORDER BY &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escapeId</span><span class="token punctuation">(</span>sorter<span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>It also supports adding qualified identifiers. It will escape both parts.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> sorter <span class="token operator">=</span> <span class="token string">&apos;date&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">&apos;SELECT * FROM posts ORDER BY &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escapeId</span><span class="token punctuation">(</span><span class="token string">&apos;posts.&apos;</span> <span class="token operator">+</span> sorter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// -&gt; SELECT * FROM posts ORDER BY `posts`.`date`</span>
</pre><p>If you do not want to treat <code>.</code> as qualified identifiers, you can set the second<br>
argument to <code>true</code> in order to keep the string as a literal identifier:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> sorter <span class="token operator">=</span> <span class="token string">&apos;date.2&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">&apos;SELECT * FROM posts ORDER BY &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escapeId</span><span class="token punctuation">(</span>sorter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// -&gt; SELECT * FROM posts ORDER BY `date.2`</span>
</pre><p>Alternatively, you can use <code>??</code> characters as placeholders for identifiers you would<br>
like to have escaped like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&apos;username&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;email&apos;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT ?? FROM ?? WHERE id = ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>columns<span class="token punctuation">,</span> <span class="token string">&apos;users&apos;</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SELECT `username`, `email` FROM `users` WHERE id = 1</span>
</pre><p><strong>Please note that this last character sequence is experimental and syntax might change</strong></p>
<p>When you pass an Object to <code>.escape()</code> or <code>.query()</code>, <code>.escapeId()</code> is used to avoid SQL injection in object keys.</p>
<h3 class="mume-header" id="preparing-queries">Preparing Queries</h3>

<p>You can use mysql.format to prepare a query with multiple insertion points, utilizing the proper escaping for ids and values. A simple example of this follows:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM ?? WHERE ?? = ?&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inserts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&apos;users&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;id&apos;</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">;</span>
sql <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> inserts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Following this you then have a valid, escaped query that you can then send to the database safely. This is useful if you are looking to prepare the query before actually sending it to the database. As mysql.format is exposed from SqlString.format you also have the option (but are not required) to pass in stringifyObject and timezone, allowing you provide a custom means of turning objects into strings, as well as a location-specific/timezone-aware Date.</p>
<h3 class="mume-header" id="custom-format">Custom format</h3>

<p>If you prefer to have another type of query escape format, there&apos;s a connection configuration option you can use to define a custom format function. You can access the connection object if you want to use the built-in <code>.escape()</code> or any other connection function.</p>
<p>Here&apos;s an example of how to implement another format:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">queryFormat</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>values<span class="token punctuation">)</span> <span class="token keyword">return</span> query<span class="token punctuation">;</span>
  <span class="token keyword">return</span> query<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\:(\w+)/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">txt<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> txt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE posts SET title = :title&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Hello MySQL&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="getting-the-id-of-an-inserted-row">Getting the id of an inserted row</h2>

<p>If you are inserting a row into a table with an auto increment primary key, you<br>
can retrieve the insert id like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO posts SET ?&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token punctuation">:</span> <span class="token string">&apos;test&apos;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>insertId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>When dealing with big numbers (above JavaScript Number precision limit), you should<br>
consider enabling <code>supportBigNumbers</code> option to be able to read the insert id as a<br>
string, otherwise it will throw an error.</p>
<p>This option is also required when fetching big numbers from the database, otherwise<br>
you will get values rounded to hundreds or thousands due to the precision limit.</p>
<h2 class="mume-header" id="getting-the-number-of-affected-rows">Getting the number of affected rows</h2>

<p>You can get the number of affected rows from an insert, update or delete statement.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;DELETE FROM posts WHERE title = &quot;wrong&quot;&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;deleted &apos;</span> <span class="token operator">+</span> results<span class="token punctuation">.</span>affectedRows <span class="token operator">+</span> <span class="token string">&apos; rows&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><h2 class="mume-header" id="getting-the-number-of-changed-rows">Getting the number of changed rows</h2>

<p>You can get the number of changed rows from an update statement.</p>
<p>&quot;changedRows&quot; differs from &quot;affectedRows&quot; in that it does not count updated rows<br>
whose values were not changed.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;UPDATE posts SET ...&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;changed &apos;</span> <span class="token operator">+</span> results<span class="token punctuation">.</span>changedRows <span class="token operator">+</span> <span class="token string">&apos; rows&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><h2 class="mume-header" id="getting-the-connection-id">Getting the connection ID</h2>

<p>You can get the MySQL connection ID (&quot;thread ID&quot;) of a given connection using the <code>threadId</code><br>
property.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;connected as id &apos;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="executing-queries-in-parallel">Executing queries in parallel</h2>

<p>The MySQL protocol is sequential, this means that you need multiple connections<br>
to execute queries in parallel. You can use a Pool to manage connections, one<br>
simple approach is to create one connection per incoming http request.</p>
<h2 class="mume-header" id="streaming-query-rows">Streaming query rows</h2>

<p>Sometimes you may want to select large quantities of rows and process each of<br>
them as they are received. This can be done like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM posts&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;error&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle error, an &apos;end&apos; event will be emitted after this as well</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;fields&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the field packets for the rows to follow</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;result&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pausing the connnection is useful if your processing involves I/O</span>
    connection<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">processRow</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;end&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// all rows have been received</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Please note a few things about the example above:</p>
<ul>
<li>Usually you will want to receive a certain amount of rows before starting to<br>
throttle the connection using <code>pause()</code>. This number will depend on the<br>
amount and size of your rows.</li>
<li><code>pause()</code> / <code>resume()</code> operate on the underlying socket and parser. You are<br>
guaranteed that no more <code>&apos;result&apos;</code> events will fire after calling <code>pause()</code>.</li>
<li>You MUST NOT provide a callback to the <code>query()</code> method when streaming rows.</li>
<li>The <code>&apos;result&apos;</code> event will fire for both rows as well as OK packets<br>
confirming the success of a INSERT/UPDATE query.</li>
<li>It is very important not to leave the result paused too long, or you may<br>
encounter <code>Error: Connection lost: The server closed the connection.</code><br>
The time limit for this is determined by the<br>
<a href="https://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_net_write_timeout">net_write_timeout setting</a><br>
on your MySQL server.</li>
</ul>
<p>Additionally you may be interested to know that it is currently not possible to<br>
stream individual row columns, they will always be buffered up entirely. If you<br>
have a good use case for streaming large fields to and from MySQL, I&apos;d love to<br>
get your thoughts and contributions on this.</p>
<h3 class="mume-header" id="piping-results-with-streams">Piping results with Streams</h3>

<p>The query object provides a convenience method <code>.stream([options])</code> that wraps<br>
query events into a <a href="http://nodejs.org/api/stream.html#stream_class_stream_readable">Readable Stream</a><br>
object. This stream can easily be piped downstream and provides automatic<br>
pause/resume, based on downstream congestion and the optional <code>highWaterMark</code>.<br>
The <code>objectMode</code> parameter of the stream is set to <code>true</code> and cannot be changed<br>
(if you need a byte stream, you will need to use a transform stream, like<br>
<a href="https://www.npmjs.com/package/objstream">objstream</a> for example).</p>
<p>For example, piping query results into another stream (with a max buffer of 5<br>
objects) is simply:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM posts&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>highWaterMark<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="multiple-statement-queries">Multiple statement queries</h2>

<p>Support for multiple statements is disabled for security reasons (it allows for<br>
SQL injection attacks if values are not properly escaped). To use this feature<br>
you have to enable it for your connection:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>multipleStatements<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Once enabled, you can execute multiple statement queries like any other query:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1; SELECT 2&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// `results` is an array with one element for every statement in the query:</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{1: 1}]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{2: 2}]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Additionally you can also stream the results of multiple statement queries:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1; SELECT 2&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

query
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;fields&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the fields for the result rows that follow</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;result&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// index refers to the statement this result belongs to (starts at 0)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>If one of the statements in your query causes an error, the resulting Error<br>
object contains a <code>err.index</code> property which tells you which statement caused<br>
it. MySQL will also stop executing any remaining statements when an error<br>
occurs.</p>
<p>Please note that the interface for streaming multiple statement queries is<br>
experimental and I am looking forward to feedback on it.</p>
<h2 class="mume-header" id="stored-procedures">Stored procedures</h2>

<p>You can call stored procedures from your queries as with any other mysql driver.<br>
If the stored procedure produces several result sets, they are exposed to you<br>
the same way as the results for multiple statement queries.</p>
<h2 class="mume-header" id="joins-with-overlapping-column-names">Joins with overlapping column names</h2>

<p>When executing joins, you are likely to get result sets with overlapping column<br>
names.</p>
<p>By default, node-mysql will overwrite colliding column names in the<br>
order the columns are received from MySQL, causing some of the received values<br>
to be unavailable.</p>
<p>However, you can also specify that you want your columns to be nested below<br>
the table name like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token punctuation">:</span> <span class="token string">&apos;...&apos;</span><span class="token punctuation">,</span> nestTables<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">/* results will be an array like this now:
  [{
    table1: {
      fieldA: &apos;...&apos;,
      fieldB: &apos;...&apos;,
    },
    table2: {
      fieldA: &apos;...&apos;,
      fieldB: &apos;...&apos;,
    },
  }, ...]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Or use a string separator to have your results merged.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token punctuation">:</span> <span class="token string">&apos;...&apos;</span><span class="token punctuation">,</span> nestTables<span class="token punctuation">:</span> <span class="token string">&apos;_&apos;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">/* results will be an array like this now:
  [{
    table1_fieldA: &apos;...&apos;,
    table1_fieldB: &apos;...&apos;,
    table2_fieldA: &apos;...&apos;,
    table2_fieldB: &apos;...&apos;,
  }, ...]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="transactions">Transactions</h2>

<p>Simple transaction support is available at the connection level:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO posts SET title=?&apos;</span><span class="token punctuation">,</span> title<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token string">&apos;Post &apos;</span> <span class="token operator">+</span> results<span class="token punctuation">.</span>insertId <span class="token operator">+</span> <span class="token string">&apos; added&apos;</span><span class="token punctuation">;</span>

    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO log SET data=?&apos;</span><span class="token punctuation">,</span> log<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;success!&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Please note that beginTransaction(), commit() and rollback() are simply convenience<br>
functions that execute the START TRANSACTION, COMMIT, and ROLLBACK commands respectively.<br>
It is important to understand that many commands in MySQL can cause an implicit commit,<br>
as described <a href="http://dev.mysql.com/doc/refman/5.5/en/implicit-commit.html">in the MySQL documentation</a></p>
<h2 class="mume-header" id="ping">Ping</h2>

<p>A ping packet can be sent over a connection using the <code>connection.ping</code> method. This<br>
method will send a ping packet to the server and when the server responds, the callback<br>
will fire. If an error occurred, the callback will fire with an error argument.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;Server responded to ping&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><h2 class="mume-header" id="timeouts">Timeouts</h2>

<p>Every operation takes an optional inactivity timeout option. This allows you to<br>
specify appropriate timeouts for operations. It is important to note that these<br>
timeouts are not part of the MySQL protocol, and rather timeout operations through<br>
the client. This means that when a timeout is reached, the connection it occurred<br>
on will be destroyed and no further operations can be performed.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Kill query after 60s</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sql<span class="token punctuation">:</span> <span class="token string">&apos;SELECT COUNT(*) AS count FROM big_table&apos;</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">&apos;PROTOCOL_SEQUENCE_TIMEOUT&apos;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&apos;too long to count table rows!&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">&apos; rows&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="error-handling">Error handling</h2>

<p>This module comes with a consistent approach to error handling that you should<br>
review carefully in order to write solid applications.</p>
<p>Most errors created by this module are instances of the JavaScript <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a><br>
object. Additionally they typically come with two extra properties:</p>
<ul>
<li><code>err.code</code>: String, contains the MySQL server error symbol if the error is<br>
a <a href="https://dev.mysql.com/doc/refman/5.5/en/server-error-reference.html">MySQL server error</a> (e.g. <code>&apos;ER_ACCESS_DENIED_ERROR&apos;</code>), a Node.js error<br>
code if it is a Node.js error (e.g. <code>&apos;ECONNREFUSED&apos;</code>), or an internal error<br>
code (e.g. <code>&apos;PROTOCOL_CONNECTION_LOST&apos;</code>).</li>
<li><code>err.errno</code>: Number, contains the MySQL server error number. Only populated<br>
from <a href="https://dev.mysql.com/doc/refman/5.5/en/server-error-reference.html">MySQL server error</a>.</li>
<li><code>err.fatal</code>: Boolean, indicating if this error is terminal to the connection<br>
object. If the error is not from a MySQL protocol operation, this property<br>
will not be defined.</li>
<li><code>err.sql</code>: String, contains the full SQL of the failed query. This can be<br>
useful when using a higher level interface like an ORM that is generating<br>
the queries.</li>
<li><code>err.sqlState</code>: String, contains the five-character SQLSTATE value. Only populated from <a href="https://dev.mysql.com/doc/refman/5.5/en/server-error-reference.html">MySQL server error</a>.</li>
<li><code>err.sqlMessage</code>: String, contains the message string that provides a<br>
textual description of the error. Only populated from <a href="https://dev.mysql.com/doc/refman/5.5/en/server-error-reference.html">MySQL server error</a>.</li>
</ul>
<p>Fatal errors are propagated to <em>all</em> pending callbacks. In the example below, a<br>
fatal error is triggered by trying to connect to an invalid port. Therefore the<br>
error object is propagated to both pending callbacks:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  port<span class="token punctuation">:</span> <span class="token number">84943</span><span class="token punctuation">,</span> <span class="token comment">// WRONG PORT</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &apos;ECONNREFUSED&apos;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>fatal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &apos;ECONNREFUSED&apos;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>fatal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Normal errors however are only delegated to the callback they belong to.  So in<br>
the example below, only the first callback receives an error, the second query<br>
works as expected:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;USE name_of_db_that_does_not_exist&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &apos;ER_BAD_DB_ERROR&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;SELECT 1&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Last but not least: If a fatal errors occurs and there are no pending<br>
callbacks, or a normal error occurs which has no callback belonging to it, the<br>
error is emitted as an <code>&apos;error&apos;</code> event on the connection object. This is<br>
demonstrated in the example below:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;error&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &apos;ER_BAD_DB_ERROR&apos;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&apos;USE name_of_db_that_does_not_exist&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Note: <code>&apos;error&apos;</code> events are special in node. If they occur without an attached<br>
listener, a stack trace is printed and your process is killed.</p>
<p><strong>tl;dr:</strong> This module does not want you to deal with silent failures. You<br>
should always provide callbacks to your method calls. If you want to ignore<br>
this advice and suppress unhandled errors, you can do this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// I am Chuck Norris:</span>
connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&apos;error&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="exception-safety">Exception Safety</h2>

<p>This module is exception safe. That means you can continue to use it, even if<br>
one of your callback functions throws an error which you&apos;re catching using<br>
&apos;uncaughtException&apos; or a domain.</p>
<h2 class="mume-header" id="type-casting">Type casting</h2>

<p>For your convenience, this driver will cast mysql types into native JavaScript<br>
types by default. The following mappings exist:</p>
<h3 class="mume-header" id="number">Number</h3>

<ul>
<li>TINYINT</li>
<li>SMALLINT</li>
<li>INT</li>
<li>MEDIUMINT</li>
<li>YEAR</li>
<li>FLOAT</li>
<li>DOUBLE</li>
</ul>
<h3 class="mume-header" id="date">Date</h3>

<ul>
<li>TIMESTAMP</li>
<li>DATE</li>
<li>DATETIME</li>
</ul>
<h3 class="mume-header" id="buffer">Buffer</h3>

<ul>
<li>TINYBLOB</li>
<li>MEDIUMBLOB</li>
<li>LONGBLOB</li>
<li>BLOB</li>
<li>BINARY</li>
<li>VARBINARY</li>
<li>BIT (last byte will be filled with 0 bits as necessary)</li>
</ul>
<h3 class="mume-header" id="string">String</h3>

<p><strong>Note</strong> text in the binary character set is returned as <code>Buffer</code>, rather<br>
than a string.</p>
<ul>
<li>CHAR</li>
<li>VARCHAR</li>
<li>TINYTEXT</li>
<li>MEDIUMTEXT</li>
<li>LONGTEXT</li>
<li>TEXT</li>
<li>ENUM</li>
<li>SET</li>
<li>DECIMAL (may exceed float precision)</li>
<li>BIGINT (may exceed float precision)</li>
<li>TIME (could be mapped to Date, but what date would be set?)</li>
<li>GEOMETRY (never used those, get in touch if you do)</li>
</ul>
<p>It is not recommended (and may go away / change in the future) to disable type<br>
casting, but you can currently do so on either the connection:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mysql&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>typeCast<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Or on the query level:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token punctuation">:</span> <span class="token string">&apos;...&apos;</span><span class="token punctuation">,</span> typeCast<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="custom-type-casting">Custom type casting</h3>

<p>You can also pass a function and handle type casting yourself. You&apos;re given some<br>
column information like database, table and name and also type and length. If you<br>
just want to apply a custom type casting to a specific type you can do it and then<br>
fallback to the default.</p>
<p>The function is provided two arguments <code>field</code> and <code>next</code> and is expected to<br>
return the value for the given field by invoking the parser functions through<br>
the <code>field</code> object.</p>
<p>The <code>field</code> argument is a <code>Field</code> object and contains data about the field that<br>
need to be parsed. The following are some of the properties on a <code>Field</code> object:</p>
<ul>
<li><code>db</code> - a string of the database the field came from.</li>
<li><code>table</code> - a string of the table the field came from.</li>
<li><code>name</code> - a string of the field name.</li>
<li><code>type</code> - a string of the field type in all caps.</li>
<li><code>length</code> - a number of the field length, as given by the database.</li>
</ul>
<p>The <code>next</code> argument is a <code>function</code> that, when called, will return the default<br>
type conversion for the given field.</p>
<p>When getting the field data, the following helper methods are present on the<br>
<code>field</code> object:</p>
<ul>
<li><code>.string()</code> - parse the field into a string.</li>
<li><code>.buffer()</code> - parse the field into a <code>Buffer</code>.</li>
<li><code>.geometry()</code> - parse the field as a geometry value.</li>
</ul>
<p>The MySQL protocol is a text-based protocol. This means that over the wire, all<br>
field types are represented as a string, which is why only string-like functions<br>
are available on the <code>field</code> object. Based on the type information (like <code>INT</code>),<br>
the type cast should convert the string field into a different JavaScript type<br>
(like a <code>number</code>).</p>
<p>Here&apos;s an example of converting <code>TINYINT(1)</code> to boolean:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">typeCast</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">field<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&apos;TINY&apos;</span> <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&apos;1&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 = true, 0 = false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p><strong>WARNING: YOU MUST INVOKE the parser using one of these three field functions<br>
in your custom typeCast callback. They can only be called once.</strong></p>
<h2 class="mume-header" id="debugging-and-reporting-problems">Debugging and reporting problems</h2>

<p>If you are running into problems, one thing that may help is enabling the<br>
<code>debug</code> mode for the connection:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>This will print all incoming and outgoing packets on stdout. You can also restrict debugging to<br>
packet types by passing an array of types to debug:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&apos;ComQueryPacket&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;RowDataPacket&apos;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>to restrict debugging to the query and data packets.</p>
<p>If that does not help, feel free to open a GitHub issue. A good GitHub issue<br>
will have:</p>
<ul>
<li>The minimal amount of code required to reproduce the problem (if possible)</li>
<li>As much debugging output and information about your environment (mysql<br>
version, node version, os, etc.) as you can gather.</li>
</ul>
<h2 class="mume-header" id="security-issues">Security issues</h2>

<p>Security issues should not be first reported through GitHub or another public<br>
forum, but kept private in order for the collaborators to assess the report<br>
and either (a) devise a fix and plan a release date or (b) assert that it is<br>
not a security issue (in which case it can be posted in a public forum, like<br>
a GitHub issue).</p>
<p>The primary private forum is email, either by emailing the module&apos;s author or<br>
opening a GitHub issue simply asking to whom a security issues should be<br>
addressed to without disclosing the issue or type of issue.</p>
<p>An ideal report would include a clear indication of what the security issue is<br>
and how it would be exploited, ideally with an accompanying proof of concept<br>
(&quot;PoC&quot;) for collaborators to work against and validate potentional fixes against.</p>
<h2 class="mume-header" id="contributing">Contributing</h2>

<p>This project welcomes contributions from the community. Contributions are<br>
accepted using GitHub pull requests. If you&apos;re not familiar with making<br>
GitHub pull requests, please refer to the<br>
<a href="https://help.github.com/articles/creating-a-pull-request/">GitHub documentation &quot;Creating a pull request&quot;</a>.</p>
<p>For a good pull request, we ask you provide the following:</p>
<ol>
<li>Try to include a clear description of your pull request in the description.<br>
It should include the basic &quot;what&quot; and &quot;why&quot;s for the request.</li>
<li>The tests should pass as best as you can. See the <a href="#running-tests">Running tests</a><br>
section on how to run the different tests. GitHub will automatically run<br>
the tests as well, to act as a safety net.</li>
<li>The pull request should include tests for the change. A new feature should<br>
have tests for the new feature and bug fixes should include a test that fails<br>
without the corresponding code change and passes after they are applied.<br>
The command <code>npm run test-cov</code> will generate a <code>coverage/</code> folder that<br>
contains HTML pages of the code coverage, to better understand if everything<br>
you&apos;re adding is being tested.</li>
<li>If the pull request is a new feature, please be sure to include all<br>
appropriate documentation additions in the <code>Readme.md</code> file as well.</li>
<li>To help ensure that your code is similar in style to the existing code,<br>
run the command <code>npm run lint</code> and fix any displayed issues.</li>
</ol>
<h2 class="mume-header" id="running-tests">Running tests</h2>

<p>The test suite is split into two parts: unit tests and integration tests.<br>
The unit tests run on any machine while the integration tests require a<br>
MySQL server instance to be setup.</p>
<h3 class="mume-header" id="running-unit-tests">Running unit tests</h3>

<pre data-role="codeBlock" data-info="sh" class="language-bash">$ FILTER<span class="token operator">=</span>unit <span class="token function">npm</span> <span class="token function">test</span>
</pre><h3 class="mume-header" id="running-integration-tests">Running integration tests</h3>

<p>Set the environment variables <code>MYSQL_DATABASE</code>, <code>MYSQL_HOST</code>, <code>MYSQL_PORT</code>,<br>
<code>MYSQL_USER</code> and <code>MYSQL_PASSWORD</code>. <code>MYSQL_SOCKET</code> can also be used in place<br>
of <code>MYSQL_HOST</code> and <code>MYSQL_PORT</code> to connect over a UNIX socket. Then run<br>
<code>npm test</code>.</p>
<p>For example, if you have an installation of mysql running on localhost:3306<br>
and no password set for the <code>root</code> user, run:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">$ mysql -u root -e <span class="token string">&quot;CREATE DATABASE IF NOT EXISTS node_mysql_test&quot;</span>
$ MYSQL_HOST<span class="token operator">=</span>localhost MYSQL_PORT<span class="token operator">=</span>3306 MYSQL_DATABASE<span class="token operator">=</span>node_mysql_test MYSQL_USER<span class="token operator">=</span>root MYSQL_PASSWORD<span class="token operator">=</span> FILTER<span class="token operator">=</span>integration <span class="token function">npm</span> <span class="token function">test</span>
</pre><h2 class="mume-header" id="todo">Todo</h2>

<ul>
<li>Prepared statements</li>
<li>Support for encodings other than UTF-8 / ASCII</li>
</ul>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>